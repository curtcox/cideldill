#!/usr/bin/env python3
"""Breakpoint Server Runner Script.

This script starts the interactive breakpoint web server for debugging
and controlling execution flow through a web interface.

Usage:
    breakpoint_server [OPTIONS]

Options:
    --port PORT         Port to listen on (default: 5174)
    --host HOST         Host to bind to (default: 0.0.0.0)
    --debug             Enable debug logging for successful poll requests
    --db PATH           SQLite DB path (default: auto-created disk DB)
    --memory            Use in-memory SQLite DB
    -h, --help          Show this help message

Examples:
    # Run with default settings (port 5174)
    breakpoint_server

    # Run on a custom port
    breakpoint_server --port 8080

    # Bind to localhost only
    breakpoint_server --host 127.0.0.1

    # Enable debug logging for poll requests
    breakpoint_server --debug

    # Use in-memory database
    breakpoint_server --memory

    # Use a specific database file
    breakpoint_server --db /path/to/breakpoints.sqlite3
"""

import argparse
import os
import sys
from datetime import datetime
from pathlib import Path

script_dir = Path(__file__).parent
repo_root = script_dir.parent.parent
sys.path.insert(0, str(repo_root))
sys.path.insert(0, str(repo_root / "server" / "src"))


def _candidate_venv_pythons() -> list[tuple[Path, Path]]:
    candidates: list[tuple[Path, Path]] = []

    venv_env = os.environ.get("VIRTUAL_ENV")
    if venv_env:
        venv_root = Path(venv_env)
        candidates.append((venv_root / "bin" / "python", venv_root))

    venv_root = repo_root / "venv"
    candidates.append((venv_root / "bin" / "python", venv_root))

    dot_venv_root = repo_root / ".venv"
    candidates.append((dot_venv_root / "bin" / "python", dot_venv_root))

    return [pair for pair in candidates if pair[0].exists()]


def _reexec_with_venv_python() -> None:
    if os.environ.get("CIDELDILL_SKIP_VENV_REEXEC") == "1":
        return

    candidates = _candidate_venv_pythons()
    if not candidates:
        return

    try:
        current_prefix = Path(sys.prefix).resolve()
    except OSError:
        current_prefix = None

    for _venv_python, venv_root in candidates:
        try:
            if current_prefix is not None and current_prefix == venv_root.resolve():
                return
        except OSError:
            continue

    venv_python, _venv_root = candidates[0]
    os.execv(str(venv_python), [str(venv_python)] + sys.argv)


_reexec_with_venv_python()

from cideldill_server.breakpoint_manager import BreakpointManager
from cideldill_server.breakpoint_server import BreakpointServer


def parse_args():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Start the CID el Dill interactive breakpoint web server",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  breakpoint_server                  # Run on default port 5174
  breakpoint_server --port 8080      # Run on custom port
  breakpoint_server --host 127.0.0.1 # Bind to localhost only
  breakpoint_server --memory         # Use in-memory DB
  breakpoint_server --db /path/to/breakpoints.sqlite3
        """
    )

    parser.add_argument(
        "--port",
        type=int,
        default=5174,
        help="Port to listen on (default: 5174)"
    )

    parser.add_argument(
        "--host",
        default="0.0.0.0",
        help="Host to bind to (default: 0.0.0.0)"
    )

    parser.add_argument(
        "--debug",
        action="store_true",
        help="Enable debug logging for successful poll requests"
    )

    db_group = parser.add_mutually_exclusive_group()
    db_group.add_argument(
        "--db",
        default=None,
        help=(
            "SQLite database file for payload storage. Defaults to an auto-created "
            "disk DB under .cideldill/breakpoint_dbs. Use ':memory:' for in-memory."
        ),
    )
    db_group.add_argument(
        "--memory",
        action="store_true",
        help="Use an in-memory SQLite database (equivalent to --db :memory:).",
    )

    return parser.parse_args()


def resolve_db_path(args) -> str:
    if args.memory:
        return ":memory:"
    if args.db:
        if args.db == ":memory:":
            return ":memory:"
        db_path = Path(args.db).expanduser()
        if not db_path.is_absolute():
            db_path = (Path.cwd() / db_path).resolve()
        db_path.parent.mkdir(parents=True, exist_ok=True)
        return str(db_path)

    db_dir = repo_root / ".cideldill" / "breakpoint_dbs"
    db_dir.mkdir(parents=True, exist_ok=True)
    timestamp = datetime.now().strftime("%Y%m%d-%H%M%S-%f")
    db_path = db_dir / f"breakpoints-{timestamp}.sqlite3"
    return str(db_path)


def main():
    """Main entry point for the script."""
    args = parse_args()
    db_path = resolve_db_path(args)

    print("=" * 60)
    print("CID el Dill - Interactive Breakpoint Server")
    print("=" * 60)
    print(f"\nStarting server (requested port: {args.port})...")
    print("\nNote: If port is occupied, a free port will be auto-selected.")
    print("      Port will be written to: ~/.cideldill/port")
    print("\nWeb UI available at:")
    print("  Check server output for the actual port.")
    print("\nAPI Endpoints:")
    print("  GET    /api/breakpoints        - List breakpoints")
    print("  POST   /api/breakpoints        - Add breakpoint")
    print("  DELETE /api/breakpoints/<name> - Remove breakpoint")
    print("  GET    /api/paused             - List paused executions")
    print("  POST   /api/paused/<id>/continue - Continue execution")
    print(f"\nDatabase: {db_path}")
    print("\nPress Ctrl+C to stop the server")
    print("=" * 60)

    try:
        manager = BreakpointManager()
        server = BreakpointServer(
            manager,
            port=args.port,
            host=args.host,
            debug_enabled=args.debug,
            db_path=db_path,
        )
        print("\n✓ Server is starting...\n")
        server.start()
    except KeyboardInterrupt:
        print("\n\n✓ Server stopped by user")
        return 0
    except Exception as e:
        print(f"\n✗ Error starting server: {e}", file=sys.stderr)
        return 1

    return 0


if __name__ == "__main__":
    sys.exit(main())
