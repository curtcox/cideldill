#!/usr/bin/env python3
"""Sequence Demo with Breakpoints.

This script demonstrates the use of breakpoints with the sequence_demo example.
It starts the breakpoint server, sets breakpoints on key sequence_demo functions,
launches the demo with debugging enabled, and opens a browser to the breakpoint UI.

Usage:
    sequence_demo_breakpoints [OPTIONS]

Options:
    --port PORT         Port for breakpoint server (default: 5174)
    --iterations N      Number of iterations to run (default: 10)
    --no-browser        Don't open browser automatically
    -h, --help          Show this help message

Examples:
    # Run with defaults (port 5174, 10 iterations, open browser)
    sequence_demo_breakpoints

    # Run on custom port with more iterations
    sequence_demo_breakpoints --port 8080 --iterations 20

    # Run without opening browser
    sequence_demo_breakpoints --no-browser
"""

import argparse
import os
import subprocess
import sys
import time
import webbrowser
from pathlib import Path

# Add src to path if running from repo
script_dir = Path(__file__).parent
repo_root = script_dir.parent.parent
sys.path.insert(0, str(repo_root / "client" / "src"))
sys.path.insert(0, str(repo_root / "server" / "src"))

try:
    import requests
except ImportError:
    print("Error: requests module not found. Please install it:")
    print("  pip install requests")
    sys.exit(1)


def parse_args():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Run sequence demo with breakpoints and web UI",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  sequence_demo_breakpoints                  # Run with defaults
  sequence_demo_breakpoints --port 8080      # Use custom port
  sequence_demo_breakpoints --iterations 20  # Run more iterations
  sequence_demo_breakpoints --no-browser     # Don't open browser
        """
    )

    parser.add_argument(
        "--port",
        type=int,
        default=5174,
        help="Port for breakpoint server (default: 5174)"
    )

    parser.add_argument(
        "--iterations",
        type=int,
        default=10,
        help="Number of iterations to run (default: 10)"
    )

    parser.add_argument(
        "--no-browser",
        action="store_true",
        help="Don't open browser automatically"
    )

    return parser.parse_args()


def wait_for_server(port, max_attempts=30, delay=0.5):
    """Wait for the server to be ready.

    Args:
        port: Initial port number to check
        max_attempts: Maximum number of attempts
        delay: Delay between attempts in seconds

    Returns:
        Actual port number if server is ready, None otherwise
    """
    from cideldill_server.port_discovery import read_port_file

    port_file = Path.home() / ".cideldill" / "port"

    for _ in range(max_attempts):
        actual_port = read_port_file(port_file) or port
        url = f"http://localhost:{actual_port}/api/breakpoints"
        try:
            response = requests.get(url, timeout=1)
            if response.status_code == 200:
                return actual_port
        except requests.exceptions.RequestException:
            pass
        time.sleep(delay)
    return None


def set_breakpoints(port):
    """Set breakpoints on key sequence_demo functions.

    Args:
        port: Port number of the breakpoint server

    Returns:
        True if breakpoints were set successfully, False otherwise
    """
    url = f"http://localhost:{port}/api/breakpoints"

    # Key functions to set breakpoints on
    breakpoint_functions = [
        "whole_numbers",
        "announce_say_default",
        "delay_1s",
    ]

    success = True
    for func_name in breakpoint_functions:
        try:
            response = requests.post(
                url,
                json={"function_name": func_name},
                timeout=5
            )
            if response.status_code == 200:
                print(f"✓ Set breakpoint on: {func_name}")
            else:
                print(f"✗ Failed to set breakpoint on: {func_name}")
                success = False
        except requests.exceptions.RequestException as e:
            print(f"✗ Error setting breakpoint on {func_name}: {e}")
            success = False

    return success


def main():
    """Main entry point."""
    args = parse_args()

    print("=" * 60)
    print("CID el Dill - Sequence Demo with Breakpoints")
    print("=" * 60)
    print()

    # Start the breakpoint server
    server_script = script_dir / "breakpoint_server"
    if not server_script.exists():
        print(f"✗ Error: Breakpoint server script not found at {server_script}")
        return 1

    print(f"Starting breakpoint server on port {args.port}...")
    server_process = subprocess.Popen(
        [sys.executable, str(server_script), "--port", str(args.port)],
    )

    # Give the server time to start
    print("Waiting for server to be ready...")
    actual_port = wait_for_server(args.port)
    if not actual_port:
        print("✗ Error: Server failed to start")
        server_process.terminate()
        return 1

    print(f"✓ Server is ready on port {actual_port}")
    print()

    print("Breakpoints will be registered by with_debug() as the demo starts.")
    print()

    # Open browser to the UI
    ui_url = f"http://localhost:{actual_port}/"
    if not args.no_browser:
        print(f"Opening browser to: {ui_url}")
        try:
            webbrowser.open(ui_url)
            print("✓ Browser opened")
        except Exception as e:
            print(f"⚠ Warning: Could not open browser: {e}")
            print(f"   Please open manually: {ui_url}")
    else:
        print(f"Web UI available at: {ui_url}")
    print()

    # Run the sequence demo
    demo_script = repo_root / "examples" / "sequence_demo.py"
    if not demo_script.exists():
        print(f"✗ Error: Demo script not found at {demo_script}")
        server_process.terminate()
        return 1

    print(f"Starting sequence_demo with {args.iterations} iterations...")
    print("=" * 60)
    print()

    demo_process = None
    try:
        # Run the demo with debugging enabled
        demo_env = os.environ.copy()
        demo_env["CIDELDILL_SERVER_URL"] = f"http://localhost:{actual_port}"
        existing_pythonpath = demo_env.get("PYTHONPATH", "")
        pythonpaths = [str(repo_root / "client" / "src"), str(repo_root / "server" / "src")]
        pythonpaths.extend(
            [existing_pythonpath] if existing_pythonpath else []
        )
        demo_env["PYTHONPATH"] = os.pathsep.join([p for p in pythonpaths if p])
        demo_process = subprocess.Popen(
            [
                sys.executable,
                str(demo_script),
                "--debug", "ON",
                "--iterations", str(args.iterations)
            ],
            env=demo_env,
        )

        # Wait for the demo to complete
        demo_process.wait()

    except KeyboardInterrupt:
        print("\n\n✓ Interrupted by user")
        if demo_process is not None:
            demo_process.terminate()
    finally:
        print("\n" + "=" * 60)
        demo_return_code = demo_process.returncode if demo_process is not None else None
        print("✓ Sequence demo execution complete")
        if demo_return_code is not None:
            print(f"✓ Demo process exit code: {demo_return_code}")
        print()
        print("Breakpoint server is still running so you can browse the UI:")
        print(f"  {ui_url}")
        print()
        print("Press Ctrl+C to stop the breakpoint server.")

        try:
            while server_process.poll() is None:
                time.sleep(0.5)
        except KeyboardInterrupt:
            pass

        # Clean up: stop the server
        print("\nStopping breakpoint server...")
        server_process.terminate()
        server_process.wait(timeout=5)
        print("✓ Server stopped")

    print("=" * 60)
    print("✓ Sequence demo with breakpoints completed")
    print("=" * 60)
    return 0


if __name__ == "__main__":
    sys.exit(main())
